<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Report Generator</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
h2 { margin-bottom: 8px; }
.controls { margin: 10px 0; }
button { margin-right: 6px; }

table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 13px; }
th { background: #f0f0f0; cursor: move; }

.numeric { text-align: right; }
.group-header { background: #ddd; font-weight: bold; }
.page-total { background: #eef6ff; font-weight: bold; }
.grand-total { background: #e6e6e6; font-weight: bold; }

.pagination { margin-top: 10px; }

.column-box { display: inline-block; margin-right: 12px; cursor: grab; }
.column-box input[type="text"] { width: 110px; }

@media print {
  .ui-controls, .pagination { display: none !important; }
}
</style>
</head>

<body>

<div style="display:flex" class="ui-controls">
  <span style="margin-left:auto;color:#3b82f6;font-size:12px;opacity:.9">
    © 2026 Maruti
  </span>
</div>
<h2 contenteditable="true" id="reportTitle">Advanced Report Generator</h2>

<div class="ui-controls">
<label for="dbfFile" class="file-label">Upload DBF / Excel</label>
<input type="file" id="dbfFile" accept=".dbf,.xls,.xlsx">

<div class="controls">
  Group by:
  <select id="groupField"></select>

  Rows per page:
  <select id="pageSize"></select>

  <label><input type="checkbox" id="showPageTotal" checked> Page totals</label>
  <label><input type="checkbox" id="showGrandTotal" checked> Report totals</label>

  <br><br>

  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="window.print()">Export PDF</button>
  <button onclick="saveLayout()">Save Layout</button>
  <input type="file" accept=".json" onchange="loadLayout(event)">
</div>

<div class="controls">
  <strong>Columns (drag to reorder):</strong><br>
  <div id="columnSelector"></div>
</div>

</div>

<div id="report"></div>
<div class="pagination" id="pagination"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===================== STATE ===================== */

let headers = [];
let allRows = [];

let columnAliases = [];
let visibleColumns = [];
let columnFilters = [];
let columnOrder = [];

let currentPage = 1;

/* JSON restore support */
let loadedFileName = null;
let pendingLayout = null;

/* ===================== INIT ===================== */

const pageSizeSel = document.getElementById("pageSize");
for (let i = 5; i <= 100; i++) {
  const o = document.createElement("option");
  o.value = i;
  o.textContent = i;
  if (i === 50) o.selected = true;
  pageSizeSel.appendChild(o);
}

/* ===================== HELPERS ===================== */

const isNumeric = v => typeof v === "number" && !isNaN(v);

const excelSerialToDate = v =>
  typeof v === "number" && v > 30000 && v < 60000
    ? new Date((v - 25569) * 86400 * 1000).toISOString().split("T")[0]
    : v;

const normalizeGroup = v =>
  v === null || v === "" ? "(blank)" : excelSerialToDate(v);

/* ===================== LOAD DATA FILE ===================== */

document.getElementById("dbfFile").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  loadedFileName = file.name;

  const buffer = await file.arrayBuffer();
  const wb = XLSX.read(buffer, { type: "array" });
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

  headers = rows.shift();
  allRows = rows;

  /* default state */
  columnAliases = [...headers];
  visibleColumns = headers.map(() => true);
  columnFilters = headers.map(() => "");
  columnOrder = headers.map((_, i) => i);

  populateGroupFields();
  populateColumnSelector();
  currentPage = 1;

  /* apply pending layout AFTER data load */
  if (pendingLayout && pendingLayout.fileName === loadedFileName) {
    applyLayout(pendingLayout);
    pendingLayout = null;
  } else {
    render();
  }
});

/* ===================== UI BUILDERS ===================== */

function populateGroupFields() {
  const sel = document.getElementById("groupField");
  sel.innerHTML = `<option value="">(none)</option>`;
  headers.forEach((_, i) => {
    const o = document.createElement("option");
    o.value = i;
    o.textContent = columnAliases[i];
    sel.appendChild(o);
  });
}

function populateColumnSelector() {
  const c = document.getElementById("columnSelector");
  c.innerHTML = "";

  columnOrder.forEach((ci, oi) => {
    const box = document.createElement("div");
    box.className = "column-box";
    box.draggable = true;

    box.ondragstart = e => e.dataTransfer.setData("from", oi);
    box.ondragover = e => e.preventDefault();
    box.ondrop = e => {
      const from = +e.dataTransfer.getData("from");
      columnOrder.splice(oi, 0, columnOrder.splice(from, 1)[0]);
      populateColumnSelector();
      render();
    };

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = visibleColumns[ci];
    cb.onchange = () => { visibleColumns[ci] = cb.checked; render(); };

    const txt = document.createElement("input");
    txt.value = columnAliases[ci];
    txt.oninput = () => {
      columnAliases[ci] = txt.value || headers[ci];
      populateGroupFields();
      render();
    };

    box.append(cb, txt);
    c.appendChild(box);
  });
}

/* ===================== CORE ===================== */

function getFilteredRows() {
  return allRows.filter(r =>
    r.every((v, i) =>
      !visibleColumns[i] ||
      !columnFilters[i] ||
      String(excelSerialToDate(v))
        .toLowerCase()
        .includes(columnFilters[i].toLowerCase())
    )
  );
}

function render() {
  const groupIndex = groupField.value;
  const pageSize = +pageSizeSel.value;

  const rows = getFilteredRows();
  let flat = [];
  let grandTotals = {};

  rows.forEach(r =>
    columnOrder.forEach(i => {
      if (visibleColumns[i] && isNumeric(r[i]))
        grandTotals[i] = (grandTotals[i] || 0) + r[i];
    })
  );

  if (groupIndex !== "") {
    const groups = {};
    rows.forEach(r => {
      const key = normalizeGroup(r[groupIndex]);
      (groups[key] ??= []).push(r);
    });

    Object.entries(groups).forEach(([g, rs]) => {
      flat.push({ __group: g });
      flat.push(...rs);
    });
  } else {
    flat.push(...rows);
  }

  if (showGrandTotal.checked)
    flat.push({ __grand: true, totals: grandTotals });

  const pages = Math.max(1, Math.ceil(flat.length / pageSize));
  currentPage = Math.min(currentPage, pages);

  renderTable(flat.slice(
    (currentPage - 1) * pageSize,
    currentPage * pageSize
  ));

  renderPagination(pages);
}

/* ===================== TABLE ===================== */

function renderTable(rows) {
  const report = document.getElementById("report");
  report.innerHTML = "";

  const table = document.createElement("table");
  const thead = table.createTHead();
  const hr = thead.insertRow();
  const fr = thead.insertRow();

  columnOrder.forEach(i => {
    if (!visibleColumns[i]) return;
    hr.insertCell().textContent = columnAliases[i];
    const f = fr.insertCell();
    const inp = document.createElement("input");
    inp.value = columnFilters[i];
    inp.oninput = () => {
      columnFilters[i] = inp.value;
      currentPage = 1;
      render();
    };
    f.appendChild(inp);
  });

  const tbody = table.createTBody();
  let pageTotals = {};

  rows.forEach(r => {
    if (r.__group) {
      const tr = tbody.insertRow();
      const td = tr.insertCell();
      td.colSpan = columnOrder.filter(i => visibleColumns[i]).length;
      td.textContent = "▶ " + r.__group;
      td.className = "group-header";
      return;
    }

    if (r.__grand) return;

    const tr = tbody.insertRow();
    columnOrder.forEach(i => {
      if (!visibleColumns[i]) return;
      const td = tr.insertCell();
      td.textContent = excelSerialToDate(r[i]);
      if (isNumeric(r[i])) {
        td.className = "numeric";
        pageTotals[i] = (pageTotals[i] || 0) + r[i];
      }
    });
  });

  if (showPageTotal.checked) {
    const tr = tbody.insertRow();
    columnOrder.forEach(i => {
      if (!visibleColumns[i]) return;
      const td = tr.insertCell();
      td.textContent = pageTotals[i]?.toFixed(2) || "";
      td.className = "page-total numeric";
    });
  }

  if (showGrandTotal.checked) {
    const tr = tbody.insertRow();
    const g = rows.find(r => r.__grand)?.totals || {};
    columnOrder.forEach(i => {
      if (!visibleColumns[i]) return;
      const td = tr.insertCell();
      td.textContent = g[i]?.toFixed(2) || "";
      td.className = "grand-total numeric";
    });
  }

  report.appendChild(table);
}

/* ===================== PAGINATION ===================== */

function renderPagination(pages) {
  const p = document.getElementById("pagination");
  p.innerHTML = "";
  for (let i = 1; i <= pages; i++) {
    const b = document.createElement("button");
    b.textContent = i;
    b.disabled = i === currentPage;
    b.onclick = () => { currentPage = i; render(); };
    p.appendChild(b);
  }
}

/* ===================== CSV ===================== */

function exportCSV() {
  const out = [];
  out.push(columnOrder.filter(i => visibleColumns[i]).map(i => columnAliases[i]));
  getFilteredRows().forEach(r =>
    out.push(columnOrder.filter(i => visibleColumns[i]).map(i => r[i]))
  );
  const ws = XLSX.utils.aoa_to_sheet(out);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb, "report.csv");
}

/* ===================== SAVE / LOAD JSON ===================== */

function saveLayout() {
  const layout = {
    fileName: loadedFileName,
    title: reportTitle.innerText,
    columnAliases,
    visibleColumns,
    columnFilters,
    columnOrder,
    groupField: groupField.value,
    pageSize: pageSizeSel.value,
    showPageTotal: showPageTotal.checked,
    showGrandTotal: showGrandTotal.checked
  };
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([JSON.stringify(layout, null, 2)]));
  a.download = "report-layout.json";
  a.click();
}

function loadLayout(e) {
  const r = new FileReader();
  r.onload = ev => {
    const l = JSON.parse(ev.target.result);

    if (!loadedFileName || l.fileName !== loadedFileName) {
      pendingLayout = l;
      alert("Please load DBF/Excel file: " + l.fileName);
      return;
    }
    applyLayout(l);
  };
  r.readAsText(e.target.files[0]);
}

function applyLayout(l) {
  reportTitle.innerText = l.title || reportTitle.innerText;
  columnAliases = l.columnAliases;
  visibleColumns = l.visibleColumns;
  columnFilters = l.columnFilters;
  columnOrder = l.columnOrder;
  groupField.value = l.groupField ?? "";
  pageSizeSel.value = l.pageSize;
  showPageTotal.checked = l.showPageTotal;
  showGrandTotal.checked = l.showGrandTotal;

  populateGroupFields();
  populateColumnSelector();
  currentPage = 1;
  render();
}

/* ===================== EVENTS ===================== */

groupField.onchange =
pageSizeSel.onchange =
showPageTotal.onchange =
showGrandTotal.onchange = () => {
  currentPage = 1;
  render();
};
</script>

</body>
</html>
